name: Xbox Pacman Builder

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag Name'
        required: true
        default: 'v1.0.0'
      package_name:
        description: 'Package Name'
        required: true
        default: 'Xbox_Pacman'

jobs:
  build:
    runs-on: windows-2022

    env:
      SolutionPath: "emulator.uwp/pac-man-emulator-uwp.sln"
      Platform: x64
      Configuration: Debug
      BuildMode: SideLoadOnly
      AppxBundle: Never
      ProjectPath: "emulator.uwp/pac-man-emulator-uwp.csproj"
      PackageOutputRootDir: C:\AppPackage

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1
        
      - name: Generate Self-Signed Certificate
        id: generate_cert
        run: |
          $cert = New-SelfSignedCertificate -CertStoreLocation "Cert:\CurrentUser\My" -Subject "CN=MyUWPCert" -KeyAlgorithm RSA -KeyLength 2048 -Provider "Microsoft Enhanced RSA and AES Cryptographic Provider" -KeyExportPolicy Exportable -NotAfter (Get-Date).AddYears(1) -Type CodeSigningCert
          echo "THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Set Package Name
        id: set_package_name
        run: |
          echo "PACKAGE_NAME=${{ github.event.inputs.package_name }}_${{ github.event.inputs.tag_name }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

      - name: App Build
        run: |
          msbuild /restore `
            "$env:SolutionPath" `
            /p:Platform=$env:Platform `
            /p:Configuration=$env:Configuration `
            /p:UapAppxPackageBuildMode=$env:BuildMode `
            /p:AppxBundle=$env:AppxBundle `
            /p:PackageCertificateThumbprint="${{ env.THUMBPRINT }}" `
            /p:RestorePackagesConfig=true `
            /p:AppxPackageSigningEnabled=true `
            /restore
        shell: pwsh    

      - name: Locate and Archive Build Output
        run: |
          # Check if the package directory exists and list contents for verification
          $buildDir = Get-ChildItem -Path "${env:PackageOutputRootDir}" -Recurse | Where-Object { $_.PSIsContainer -and $_.Name -like "*${env.PACKAGE_NAME}*" } | Select-Object -First 1
          
          if ($null -eq $buildDir) {
            Write-Host "No build output found in ${env:PackageOutputRootDir}"
            exit 1
          } else {
            Write-Host "Build output directory found: $($buildDir.FullName)"
            Compress-Archive -Path "$($buildDir.FullName)\*" -DestinationPath "${env:PackageOutputRootDir}\${env.PACKAGE_NAME}.zip"
          }
        shell: pwsh

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: ${{ github.event.inputs.package_name }} Build
          path: ${{ env.PackageOutputRootDir }}\${{ env.PACKAGE_NAME }}.zip
